{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "12339729127578324664"
    }
  },
  "parameters": {
    "guidToEncode": {
      "type": "string",
      "metadata": {
        "description": "The GUID to encode"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for the deployment script"
      }
    },
    "utcValue": {
      "type": "string",
      "defaultValue": "[utcNow()]",
      "metadata": {
        "description": "Timestamp to force script re-execution"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2023-08-01",
      "name": "[format('guid-encoder-{0}', uniqueString(parameters('guidToEncode'), parameters('utcValue')))]",
      "location": "[parameters('location')]",
      "kind": "AzureCLI",
      "properties": {
        "azCliVersion": "2.52.0",
        "retentionInterval": "PT1H",
        "timeout": "PT5M",
        "cleanupPreference": "OnSuccess",
        "forceUpdateTag": "[parameters('utcValue')]",
        "scriptContent": "      #!/bin/bash\r\n      set -e\r\n      \r\n      GUID_VALUE=\"$1\"\r\n      \r\n      echo \"Converting GUID: $GUID_VALUE\"\r\n      \r\n      # Remove hyphens from GUID\r\n      GUID_NO_HYPHENS=$(echo \"$GUID_VALUE\" | tr -d '-')\r\n      \r\n      # Extract parts of the GUID\r\n      # GUID format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\r\n      # Byte order needs to be adjusted for little-endian encoding\r\n      PART1=\"${GUID_NO_HYPHENS:0:8}\"   # First 8 chars (4 bytes)\r\n      PART2=\"${GUID_NO_HYPHENS:8:4}\"   # Next 4 chars (2 bytes)\r\n      PART3=\"${GUID_NO_HYPHENS:12:4}\"  # Next 4 chars (2 bytes)\r\n      PART4=\"${GUID_NO_HYPHENS:16:16}\" # Last 16 chars (8 bytes)\r\n      \r\n      # Reverse byte order for first three parts (little-endian)\r\n      BYTES=\"\"\r\n      BYTES+=\"${PART1:6:2}${PART1:4:2}${PART1:2:2}${PART1:0:2}\"\r\n      BYTES+=\"${PART2:2:2}${PART2:0:2}\"\r\n      BYTES+=\"${PART3:2:2}${PART3:0:2}\"\r\n      BYTES+=\"$PART4\"\r\n      \r\n      echo \"Hex bytes: $BYTES\"\r\n      \r\n      # Convert hex to binary and then to base64\r\n      BASE64=$(echo \"$BYTES\" | xxd -r -p | base64)\r\n      \r\n      # Convert to Base64URL (remove padding, replace + with -, / with _)\r\n      BASE64URL=$(echo \"$BASE64\" | tr '+' '-' | tr '/' '_' | tr -d '=\\n')\r\n      \r\n      echo \"Base64URL encoded: $BASE64URL\"\r\n      \r\n      # Output result as JSON\r\n      echo \"{\\\"encodedGuid\\\":\\\"$BASE64URL\\\"}\" > $AZ_SCRIPTS_OUTPUT_PATH\r\n    ",
        "arguments": "[parameters('guidToEncode')]"
      }
    }
  ],
  "outputs": {
    "encodedGuid": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('guid-encoder-{0}', uniqueString(parameters('guidToEncode'), parameters('utcValue')))), '2023-08-01').outputs.encodedGuid]"
    }
  }
}