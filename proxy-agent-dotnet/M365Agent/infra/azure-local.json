{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "16409597920477405192"
    }
  },
  "parameters": {
    "botName": {
      "type": "string",
      "metadata": {
        "description": "Name of the bot (used for display and resource naming)"
      }
    },
    "botId": {
      "type": "string",
      "metadata": {
        "description": "The Bot ID (Microsoft App ID) - provided by Microsoft 365 Agents Toolkit"
      }
    },
    "botEndpoint": {
      "type": "string",
      "metadata": {
        "description": "Bot messaging endpoint (dev tunnel URL, e.g., https://abc123.devtunnels.ms:5000/api/messages)"
      }
    },
    "tenantId": {
      "type": "string",
      "metadata": {
        "description": "Tenant ID for single-tenant bot configuration"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "botServiceSku": {
      "type": "string",
      "defaultValue": "F0",
      "metadata": {
        "description": "The SKU for the Bot Service (F0 for local development)"
      }
    },
    "ssoAppId": {
      "type": "string",
      "defaultValue": "00000000-0000-0000-0000-000000000000",
      "metadata": {
        "description": "SSO App ID - use 00000000-0000-0000-0000-000000000000 for first-time deployment, provide actual GUID to skip SSO/OAuth creation"
      }
    }
  },
  "variables": {
    "botServiceName": "[format('{0}-local', parameters('botName'))]",
    "ssoAppName": "[format('{0}-sso-local', parameters('botName'))]",
    "nullGuid": "00000000-0000-0000-0000-000000000000",
    "isFirstTimeDeployment": "[equals(parameters('ssoAppId'), variables('nullGuid'))]"
  },
  "resources": [
    {
      "type": "Microsoft.BotService/botServices",
      "apiVersion": "2021-03-01",
      "name": "[variables('botServiceName')]",
      "kind": "azurebot",
      "location": "global",
      "properties": {
        "displayName": "[parameters('botName')]",
        "endpoint": "[parameters('botEndpoint')]",
        "msaAppId": "[parameters('botId')]",
        "msaAppTenantId": "[parameters('tenantId')]",
        "msaAppType": "SingleTenant"
      },
      "sku": {
        "name": "[parameters('botServiceSku')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-bot-service-principal-local')]"
      ]
    },
    {
      "type": "Microsoft.BotService/botServices/channels",
      "apiVersion": "2021-03-01",
      "name": "[format('{0}/{1}', variables('botServiceName'), 'MsTeamsChannel')]",
      "location": "global",
      "properties": {
        "channelName": "MsTeamsChannel"
      },
      "dependsOn": [
        "[resourceId('Microsoft.BotService/botServices', variables('botServiceName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-bot-service-principal-local",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appId": {
            "value": "[parameters('botId')]"
          },
          "displayName": {
            "value": "[format('{0}-bot-local', parameters('botName'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "7731494046936114432"
            }
          },
          "parameters": {
            "appId": {
              "type": "string",
              "metadata": {
                "description": "The App ID (Client ID) of the existing application registration"
              }
            },
            "displayName": {
              "type": "string",
              "metadata": {
                "description": "Display name for the service principal"
              }
            }
          },
          "imports": {
            "microsoftGraphV1": {
              "provider": "MicrosoftGraph",
              "version": "1.0.0"
            }
          },
          "resources": {
            "servicePrincipal": {
              "import": "microsoftGraphV1",
              "type": "Microsoft.Graph/servicePrincipals@v1.0",
              "properties": {
                "appId": "[parameters('appId')]",
                "accountEnabled": true,
                "displayName": "[parameters('displayName')]",
                "servicePrincipalType": "Application",
                "tags": [
                  "WindowsAzureActiveDirectoryIntegratedApp"
                ]
              }
            }
          },
          "outputs": {
            "servicePrincipalId": {
              "type": "string",
              "value": "[reference('servicePrincipal').id]"
            },
            "servicePrincipalObjectId": {
              "type": "string",
              "value": "[reference('servicePrincipal').id]"
            },
            "appId": {
              "type": "string",
              "value": "[reference('servicePrincipal').appId]"
            }
          }
        }
      }
    },
    {
      "condition": "[variables('isFirstTimeDeployment')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-sso-app-registration-local",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aadAppName": {
            "value": "[variables('ssoAppName')]"
          },
          "botId": {
            "value": "[parameters('botId')]"
          },
          "tenantId": {
            "value": "[parameters('tenantId')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "11985169748261135726"
            }
          },
          "parameters": {
            "aadAppName": {
              "type": "string",
              "metadata": {
                "description": "Application name for the Entra ID app registration"
              }
            },
            "botId": {
              "type": "string",
              "metadata": {
                "description": "BotID this should match the Microsoft App ID in the Azure Bot Service Configuration"
              }
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "Tenant ID where the application will be registered"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for resources"
              }
            }
          },
          "imports": {
            "microsoftGraphV1": {
              "provider": "MicrosoftGraph",
              "version": "1.0.0"
            }
          },
          "resources": {
            "aadApplication": {
              "import": "microsoftGraphV1",
              "type": "Microsoft.Graph/applications@v1.0",
              "properties": {
                "displayName": "[parameters('aadAppName')]",
                "uniqueName": "[parameters('aadAppName')]",
                "signInAudience": "AzureADMyOrg",
                "identifierUris": [
                  "[format('api://botid-{0}', parameters('botId'))]"
                ],
                "web": {
                  "redirectUris": [
                    "https://token.botframework.com/.auth/web/redirect"
                  ],
                  "implicitGrantSettings": {
                    "enableIdTokenIssuance": false,
                    "enableAccessTokenIssuance": false
                  }
                },
                "api": {
                  "requestedAccessTokenVersion": 2,
                  "oauth2PermissionScopes": [
                    {
                      "id": "[guid(resourceGroup().id, parameters('aadAppName'), 'access_as_user')]",
                      "adminConsentDescription": "Default scope for Agent SSO access",
                      "adminConsentDisplayName": "Agent SSO",
                      "userConsentDescription": "Default scope for Agent SSO access",
                      "userConsentDisplayName": "Agent SSO",
                      "value": "access_as_user",
                      "type": "User",
                      "isEnabled": true
                    }
                  ],
                  "preAuthorizedApplications": [
                    {
                      "appId": "1fec8e78-bce4-4aaf-ab1b-5451cc387264",
                      "delegatedPermissionIds": [
                        "[guid(resourceGroup().id, parameters('aadAppName'), 'access_as_user')]"
                      ]
                    },
                    {
                      "appId": "5e3ce6c0-2b1f-4285-8d4b-75ee78787346",
                      "delegatedPermissionIds": [
                        "[guid(resourceGroup().id, parameters('aadAppName'), 'access_as_user')]"
                      ]
                    },
                    {
                      "appId": "4765445b-32c6-49b0-83e6-1d93765276ca",
                      "delegatedPermissionIds": [
                        "[guid(resourceGroup().id, parameters('aadAppName'), 'access_as_user')]"
                      ]
                    },
                    {
                      "appId": "0ec893e0-5785-4de6-99da-4ed124e5296c",
                      "delegatedPermissionIds": [
                        "[guid(resourceGroup().id, parameters('aadAppName'), 'access_as_user')]"
                      ]
                    },
                    {
                      "appId": "d3590ed6-52b3-4102-aeff-aad2292ab01c",
                      "delegatedPermissionIds": [
                        "[guid(resourceGroup().id, parameters('aadAppName'), 'access_as_user')]"
                      ]
                    },
                    {
                      "appId": "bc59ab01-8403-45c6-8796-ac3ef710b3e3",
                      "delegatedPermissionIds": [
                        "[guid(resourceGroup().id, parameters('aadAppName'), 'access_as_user')]"
                      ]
                    },
                    {
                      "appId": "27922004-5251-4030-b22d-91ecd9a37ea4",
                      "delegatedPermissionIds": [
                        "[guid(resourceGroup().id, parameters('aadAppName'), 'access_as_user')]"
                      ]
                    }
                  ]
                },
                "requiredResourceAccess": [
                  {
                    "resourceAppId": "00000003-0000-0000-c000-000000000000",
                    "resourceAccess": [
                      {
                        "id": "37f7f235-527c-4136-accd-4a02d197296e",
                        "type": "Scope"
                      },
                      {
                        "id": "14dad69e-099b-42c9-810b-d002981feec1",
                        "type": "Scope"
                      },
                      {
                        "id": "64a6cdd6-aab1-4aaf-94b8-3cc8405e90d0",
                        "type": "Scope"
                      },
                      {
                        "id": "7427e0e9-2fba-42fe-b0c0-848c9e6a8182",
                        "type": "Scope"
                      }
                    ]
                  },
                  {
                    "resourceAppId": "18a66f5f-dbdf-4c17-9dd7-1634712a9cbe",
                    "resourceAccess": [
                      {
                        "id": "1a7925b5-f871-417a-9b8b-303f9f29fa10",
                        "type": "Scope"
                      }
                    ]
                  }
                ]
              }
            },
            "federatedCredential": {
              "import": "microsoftGraphV1",
              "type": "Microsoft.Graph/applications/federatedIdentityCredentials@v1.0",
              "properties": {
                "name": "[format('{0}/{1}', reference('aadApplication').uniqueName, guid(resourceGroup().id, parameters('aadAppName'), 'BotServiceOauthConnection'))]",
                "audiences": [
                  "api://AzureADTokenExchange"
                ],
                "issuer": "[format('{0}{1}/v2.0', environment().authentication.loginEndpoint, parameters('tenantId'))]",
                "subject": "[format('/eid1/c/pub/t/{0}/a/9ExAW52n_ky4ZiS_jhpJIQ/{1}', reference('tenantIdEncoder').outputs.encodedGuid.value, guid(resourceGroup().id, parameters('aadAppName'), 'BotServiceOauthConnection'))]",
                "description": "Federated credential for Bot Framework token exchange"
              },
              "dependsOn": [
                "aadApplication",
                "tenantIdEncoder"
              ]
            },
            "aadServicePrincipal": {
              "import": "microsoftGraphV1",
              "type": "Microsoft.Graph/servicePrincipals@v1.0",
              "properties": {
                "appId": "[reference('aadApplication').appId]",
                "accountEnabled": true,
                "displayName": "[parameters('aadAppName')]",
                "servicePrincipalType": "Application",
                "tags": [
                  "WindowsAzureActiveDirectoryIntegratedApp"
                ]
              },
              "dependsOn": [
                "aadApplication"
              ]
            },
            "tenantIdEncoder": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('encode-tenant-{0}', uniqueString(parameters('tenantId')))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "guidToEncode": {
                    "value": "[parameters('tenantId')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "12339729127578324664"
                    }
                  },
                  "parameters": {
                    "guidToEncode": {
                      "type": "string",
                      "metadata": {
                        "description": "The GUID to encode"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Location for the deployment script"
                      }
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]",
                      "metadata": {
                        "description": "Timestamp to force script re-execution"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "[format('guid-encoder-{0}', uniqueString(parameters('guidToEncode'), parameters('utcValue')))]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "properties": {
                        "azCliVersion": "2.52.0",
                        "retentionInterval": "PT1H",
                        "timeout": "PT5M",
                        "cleanupPreference": "OnSuccess",
                        "forceUpdateTag": "[parameters('utcValue')]",
                        "scriptContent": "      #!/bin/bash\r\n      set -e\r\n      \r\n      GUID_VALUE=\"$1\"\r\n      \r\n      echo \"Converting GUID: $GUID_VALUE\"\r\n      \r\n      # Remove hyphens from GUID\r\n      GUID_NO_HYPHENS=$(echo \"$GUID_VALUE\" | tr -d '-')\r\n      \r\n      # Extract parts of the GUID\r\n      # GUID format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\r\n      # Byte order needs to be adjusted for little-endian encoding\r\n      PART1=\"${GUID_NO_HYPHENS:0:8}\"   # First 8 chars (4 bytes)\r\n      PART2=\"${GUID_NO_HYPHENS:8:4}\"   # Next 4 chars (2 bytes)\r\n      PART3=\"${GUID_NO_HYPHENS:12:4}\"  # Next 4 chars (2 bytes)\r\n      PART4=\"${GUID_NO_HYPHENS:16:16}\" # Last 16 chars (8 bytes)\r\n      \r\n      # Reverse byte order for first three parts (little-endian)\r\n      BYTES=\"\"\r\n      BYTES+=\"${PART1:6:2}${PART1:4:2}${PART1:2:2}${PART1:0:2}\"\r\n      BYTES+=\"${PART2:2:2}${PART2:0:2}\"\r\n      BYTES+=\"${PART3:2:2}${PART3:0:2}\"\r\n      BYTES+=\"$PART4\"\r\n      \r\n      echo \"Hex bytes: $BYTES\"\r\n      \r\n      # Convert hex to binary and then to base64\r\n      BASE64=$(echo \"$BYTES\" | xxd -r -p | base64)\r\n      \r\n      # Convert to Base64URL (remove padding, replace + with -, / with _)\r\n      BASE64URL=$(echo \"$BASE64\" | tr '+' '-' | tr '/' '_' | tr -d '=\\n')\r\n      \r\n      echo \"Base64URL encoded: $BASE64URL\"\r\n      \r\n      # Output result as JSON\r\n      echo \"{\\\"encodedGuid\\\":\\\"$BASE64URL\\\"}\" > $AZ_SCRIPTS_OUTPUT_PATH\r\n    ",
                        "arguments": "[parameters('guidToEncode')]"
                      }
                    }
                  ],
                  "outputs": {
                    "encodedGuid": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('guid-encoder-{0}', uniqueString(parameters('guidToEncode'), parameters('utcValue')))), '2023-08-01').outputs.encodedGuid]"
                    }
                  }
                }
              }
            }
          },
          "outputs": {
            "aadAppId": {
              "type": "string",
              "value": "[reference('aadApplication').appId]"
            },
            "aadAppObjectId": {
              "type": "string",
              "value": "[reference('aadApplication').id]"
            },
            "aadAppIdUri": {
              "type": "string",
              "value": "[format('api://botid-{0}', parameters('botId'))]"
            },
            "servicePrincipalId": {
              "type": "string",
              "value": "[reference('aadServicePrincipal').id]"
            },
            "servicePrincipalObjectId": {
              "type": "string",
              "value": "[reference('aadServicePrincipal').id]"
            },
            "fciName": {
              "type": "string",
              "value": "[reference('federatedCredential').name]"
            },
            "fciSubject": {
              "type": "string",
              "value": "[format('/eid1/c/pub/t/{0}/a/9ExAW52n_ky4ZiS_jhpJIQ/{1}', reference('tenantIdEncoder').outputs.encodedGuid.value, guid(resourceGroup().id, parameters('aadAppName'), 'BotServiceOauthConnection'))]"
            }
          }
        }
      }
    },
    {
      "condition": "[variables('isFirstTimeDeployment')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-bot-oauth-connection-local",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "botServiceName": {
            "value": "[variables('botServiceName')]"
          },
          "connectionName": {
            "value": "SsoConnection"
          },
          "aadAppId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-sso-app-registration-local'), '2025-04-01').outputs.aadAppId.value]"
          },
          "aadAppIdUri": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-sso-app-registration-local'), '2025-04-01').outputs.aadAppIdUri.value]"
          },
          "federatedCredentialSubject": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-sso-app-registration-local'), '2025-04-01').outputs.fciSubject.value]"
          },
          "scopes": {
            "value": "[format('{0}/access_as_user', reference(resourceId('Microsoft.Resources/deployments', 'deploy-sso-app-registration-local'), '2025-04-01').outputs.aadAppIdUri.value)]"
          },
          "tenantId": {
            "value": "[parameters('tenantId')]"
          },
          "location": {
            "value": "global"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "9760687786267362268"
            }
          },
          "parameters": {
            "botServiceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Bot Service to configure"
              }
            },
            "connectionName": {
              "type": "string",
              "defaultValue": "SsoConnection",
              "metadata": {
                "description": "The name for the OAuth connection setting"
              }
            },
            "aadAppId": {
              "type": "string",
              "metadata": {
                "description": "The Azure AD Application (client) ID from the app registration"
              }
            },
            "aadAppIdUri": {
              "type": "string",
              "metadata": {
                "description": "The Azure AD Application ID URI (e.g., api://botid-{guid})"
              }
            },
            "federatedCredentialSubject": {
              "type": "string",
              "metadata": {
                "description": "The federated credential subject (unique identifier from the federated credential)"
              }
            },
            "scopes": {
              "type": "string",
              "metadata": {
                "description": "OAuth scopes to request - should be the app ID URI with access_as_user scope"
              }
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "The tenant ID for the Azure AD application"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "global",
              "metadata": {
                "description": "Location for the connection resource"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.BotService/botServices/connections",
              "apiVersion": "2022-09-15",
              "name": "[format('{0}/{1}', parameters('botServiceName'), parameters('connectionName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "serviceProviderId": "c00b44ab-5e16-c44c-af26-2fd5bc55eb18",
                "serviceProviderDisplayName": "AAD v2 with Federated Credentials",
                "clientId": "[parameters('aadAppId')]",
                "scopes": "[parameters('scopes')]",
                "parameters": [
                  {
                    "key": "ClientId",
                    "value": "[parameters('aadAppId')]"
                  },
                  {
                    "key": "UniqueIdentifier",
                    "value": "[parameters('federatedCredentialSubject')]"
                  },
                  {
                    "key": "TokenExchangeUrl",
                    "value": "[parameters('aadAppIdUri')]"
                  },
                  {
                    "key": "TenantId",
                    "value": "[parameters('tenantId')]"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "connectionName": {
              "type": "string",
              "value": "[parameters('connectionName')]"
            },
            "connectionId": {
              "type": "string",
              "value": "[resourceId('Microsoft.BotService/botServices/connections', split(format('{0}/{1}', parameters('botServiceName'), parameters('connectionName')), '/')[0], split(format('{0}/{1}', parameters('botServiceName'), parameters('connectionName')), '/')[1])]"
            },
            "settingId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.BotService/botServices/connections', split(format('{0}/{1}', parameters('botServiceName'), parameters('connectionName')), '/')[0], split(format('{0}/{1}', parameters('botServiceName'), parameters('connectionName')), '/')[1]), '2022-09-15').settingId]"
            },
            "provisioningState": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.BotService/botServices/connections', split(format('{0}/{1}', parameters('botServiceName'), parameters('connectionName')), '/')[0], split(format('{0}/{1}', parameters('botServiceName'), parameters('connectionName')), '/')[1]), '2022-09-15').provisioningState]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.BotService/botServices', variables('botServiceName'))]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-sso-app-registration-local')]"
      ]
    }
  ],
  "outputs": {
    "botServiceName": {
      "type": "string",
      "value": "[variables('botServiceName')]"
    },
    "botServiceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.BotService/botServices', variables('botServiceName'))]"
    },
    "botEndpoint": {
      "type": "string",
      "value": "[parameters('botEndpoint')]"
    },
    "botId": {
      "type": "string",
      "value": "[parameters('botId')]"
    },
    "tenantId": {
      "type": "string",
      "value": "[parameters('tenantId')]"
    },
    "botServicePrincipalId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-bot-service-principal-local'), '2025-04-01').outputs.servicePrincipalId.value]"
    },
    "sso_App_Id": {
      "type": "string",
      "value": "[if(variables('isFirstTimeDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-sso-app-registration-local'), '2025-04-01').outputs.aadAppId.value, parameters('ssoAppId'))]"
    },
    "ssoAppObjectId": {
      "type": "string",
      "value": "[if(variables('isFirstTimeDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-sso-app-registration-local'), '2025-04-01').outputs.aadAppObjectId.value, '')]"
    },
    "sso_App_Id_Uri": {
      "type": "string",
      "value": "[if(variables('isFirstTimeDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-sso-app-registration-local'), '2025-04-01').outputs.aadAppIdUri.value, '')]"
    },
    "ssoServicePrincipalId": {
      "type": "string",
      "value": "[if(variables('isFirstTimeDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-sso-app-registration-local'), '2025-04-01').outputs.servicePrincipalId.value, '')]"
    },
    "ssoFederatedCredentialName": {
      "type": "string",
      "value": "[if(variables('isFirstTimeDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-sso-app-registration-local'), '2025-04-01').outputs.fciName.value, '')]"
    },
    "oauth_Connection_Name": {
      "type": "string",
      "value": "[if(variables('isFirstTimeDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-bot-oauth-connection-local'), '2025-04-01').outputs.connectionName.value, 'SsoConnection')]"
    },
    "oauthConnectionId": {
      "type": "string",
      "value": "[if(variables('isFirstTimeDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-bot-oauth-connection-local'), '2025-04-01').outputs.connectionId.value, '')]"
    },
    "oauthSettingId": {
      "type": "string",
      "value": "[if(variables('isFirstTimeDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-bot-oauth-connection-local'), '2025-04-01').outputs.settingId.value, '')]"
    },
    "localDevSummary": {
      "type": "object",
      "value": {
        "botName": "[parameters('botName')]",
        "botServiceName": "[variables('botServiceName')]",
        "botEndpoint": "[parameters('botEndpoint')]",
        "botId": "[parameters('botId')]",
        "tenantId": "[parameters('tenantId')]",
        "botServicePrincipalId": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-bot-service-principal-local'), '2025-04-01').outputs.servicePrincipalId.value]",
        "ssoAppId": "[if(variables('isFirstTimeDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-sso-app-registration-local'), '2025-04-01').outputs.aadAppId.value, parameters('ssoAppId'))]",
        "ssoAppIdUri": "[if(variables('isFirstTimeDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-sso-app-registration-local'), '2025-04-01').outputs.aadAppIdUri.value, '')]",
        "oauthConnectionName": "SsoConnection",
        "deploymentMode": "[if(variables('isFirstTimeDeployment'), 'First-time (created all resources)', 'Update (bot endpoint only)')]"
      }
    }
  }
}