{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "14313159369453799477"
    }
  },
  "parameters": {
    "resourceBaseName": {
      "type": "string",
      "minLength": 4,
      "maxLength": 20,
      "metadata": {
        "description": "Used to generate names for all resources"
      }
    },
    "botDisplayName": {
      "type": "string",
      "maxLength": 42,
      "metadata": {
        "description": "Display name for the bot"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "webAppSKU": {
      "type": "string",
      "defaultValue": "B1",
      "allowedValues": [
        "F1",
        "B1",
        "B2",
        "B3",
        "S1",
        "S2",
        "S3",
        "P1v2",
        "P2v2",
        "P3v2"
      ],
      "metadata": {
        "description": "The SKU for the App Service Plan"
      }
    },
    "botServiceSku": {
      "type": "string",
      "defaultValue": "F0",
      "allowedValues": [
        "F0",
        "S1"
      ],
      "metadata": {
        "description": "The SKU for the Bot Service"
      }
    },
    "tenantId": {
      "type": "string",
      "defaultValue": "[tenant().tenantId]",
      "metadata": {
        "description": "Tenant ID for the Entra ID application"
      }
    },
    "enableAppInsights": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Application Insights"
      }
    },
    "additionalAppSettings": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Additional app settings for the Web App"
      }
    }
  },
  "variables": {
    "identityName": "[format('{0}-identity', parameters('resourceBaseName'))]",
    "webAppName": "[format('{0}-app', parameters('resourceBaseName'))]",
    "botServiceName": "[format('{0}-bot', parameters('resourceBaseName'))]",
    "aadAppName": "[format('{0}-app-registration', parameters('resourceBaseName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-bot-identity",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "identityName": {
            "value": "[variables('identityName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "10669994281869448212"
            }
          },
          "parameters": {
            "identityName": {
              "type": "string",
              "metadata": {
                "description": "The name of the User Assigned Managed Identity to create."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('identityName')]",
              "location": "[parameters('location')]"
            }
          ],
          "outputs": {
            "identityId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName'))]"
            },
            "identityName": {
              "type": "string",
              "value": "[parameters('identityName')]"
            },
            "identityClientId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-01-31').clientId]"
            },
            "identityPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-01-31').principalId]"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('enableAppInsights')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-app-insights",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourceBaseName": {
            "value": "[parameters('resourceBaseName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "identityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-bot-identity'), '2025-04-01').outputs.identityPrincipalId.value]"
          },
          "applicationType": {
            "value": "web"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "10700678519737501896"
            }
          },
          "parameters": {
            "resourceBaseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources"
              }
            },
            "identityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "The managed identity principal ID that will access Application Insights"
              }
            },
            "applicationType": {
              "type": "string",
              "defaultValue": "web",
              "allowedValues": [
                "web",
                "other"
              ],
              "metadata": {
                "description": "Application Insights application type"
              }
            }
          },
          "variables": {
            "monitoringMetricsPublisherRoleId": "3913510d-42f4-4e42-8a64-420c390055eb"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-law', parameters('resourceBaseName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30,
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "workspaceCapping": {
                  "dailyQuotaGb": 1
                }
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[format('{0}-ai', parameters('resourceBaseName'))]",
              "location": "[parameters('location')]",
              "kind": "[parameters('applicationType')]",
              "properties": {
                "Application_Type": "[parameters('applicationType')]",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-law', parameters('resourceBaseName')))]",
                "IngestionMode": "LogAnalytics",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled",
                "DisableLocalAuth": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-law', parameters('resourceBaseName')))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Insights/components/{0}', format('{0}-ai', parameters('resourceBaseName')))]",
              "name": "[guid(resourceId('Microsoft.Insights/components', format('{0}-ai', parameters('resourceBaseName'))), parameters('identityPrincipalId'), variables('monitoringMetricsPublisherRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('monitoringMetricsPublisherRoleId'))]",
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/components', format('{0}-ai', parameters('resourceBaseName')))]"
              ]
            }
          ],
          "outputs": {
            "appInsightsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', format('{0}-ai', parameters('resourceBaseName')))]"
            },
            "appInsightsName": {
              "type": "string",
              "value": "[format('{0}-ai', parameters('resourceBaseName'))]"
            },
            "appInsightsConnectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', format('{0}-ai', parameters('resourceBaseName'))), '2020-02-02').ConnectionString]"
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', format('{0}-ai', parameters('resourceBaseName'))), '2020-02-02').InstrumentationKey]"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-law', parameters('resourceBaseName')))]"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "value": "[format('{0}-law', parameters('resourceBaseName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-bot-identity')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-app-service",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourceBaseName": {
            "value": "[parameters('resourceBaseName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "serverfarmsName": {
            "value": "[format('{0}-plan', parameters('resourceBaseName'))]"
          },
          "webAppName": {
            "value": "[variables('webAppName')]"
          },
          "webAppSKU": {
            "value": "[parameters('webAppSKU')]"
          },
          "MSIid": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-bot-identity'), '2025-04-01').outputs.identityId.value]"
          },
          "enableAppInsights": {
            "value": "[parameters('enableAppInsights')]"
          },
          "appInsightsConnectionString": {
            "value": "[coalesce(tryGet(tryGet(tryGet(if(parameters('enableAppInsights'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-insights'), '2025-04-01'), null()), 'outputs'), 'appInsightsConnectionString'), 'value'), '')]"
          },
          "botId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-bot-identity'), '2025-04-01').outputs.identityClientId.value]"
          },
          "botTenantId": {
            "value": "[parameters('tenantId')]"
          },
          "oauthConnectionName": {
            "value": "SsoConnection"
          },
          "azureAIFoundryEndpoint": {
            "value": ""
          },
          "azureAIAgentId": {
            "value": ""
          },
          "additionalAppSettings": {
            "value": "[parameters('additionalAppSettings')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "13094359407874666778"
            }
          },
          "parameters": {
            "resourceBaseName": {
              "type": "string",
              "minLength": 4,
              "maxLength": 20,
              "metadata": {
                "description": "Used to generate names for all resources in this file"
              }
            },
            "MSIid": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the User Assigned Managed Identity"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources"
              }
            },
            "serverfarmsName": {
              "type": "string",
              "defaultValue": "[parameters('resourceBaseName')]",
              "metadata": {
                "description": "The name of the App Service Plan"
              }
            },
            "webAppName": {
              "type": "string",
              "defaultValue": "[parameters('resourceBaseName')]",
              "metadata": {
                "description": "The name of the Web App"
              }
            },
            "webAppSKU": {
              "type": "string",
              "metadata": {
                "description": "The SKU for the App Service Plan"
              }
            },
            "additionalAppSettings": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Additional app settings for the Web App"
              }
            },
            "enableAppInsights": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable Application Insights"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights connection string (for managed identity authentication)"
              }
            },
            "botId": {
              "type": "string",
              "metadata": {
                "description": "Bot ID (Managed Identity Client ID)"
              }
            },
            "botTenantId": {
              "type": "string",
              "metadata": {
                "description": "Bot Tenant ID"
              }
            },
            "oauthConnectionName": {
              "type": "string",
              "metadata": {
                "description": "OAuth Connection Name"
              }
            },
            "azureAIFoundryEndpoint": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure AI Foundry Project Endpoint (optional)"
              }
            },
            "azureAIAgentId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure AI Agent ID (optional)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-12-01",
              "name": "[parameters('serverfarmsName')]",
              "location": "[parameters('location')]",
              "kind": "app",
              "sku": {
                "name": "[parameters('webAppSKU')]"
              },
              "properties": {
                "reserved": false
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-12-01",
              "name": "[parameters('webAppName')]",
              "location": "[parameters('location')]",
              "kind": "app",
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('serverfarmsName'))]",
                "httpsOnly": true,
                "clientAffinityEnabled": false,
                "siteConfig": {
                  "alwaysOn": true,
                  "http20Enabled": true,
                  "minTlsVersion": "1.2",
                  "ftpsState": "FtpsOnly",
                  "netFrameworkVersion": "v9.0",
                  "healthCheckPath": "/health",
                  "appSettings": "[concat(createArray(createObject('name', 'ASPNETCORE_ENVIRONMENT', 'value', 'Production'), createObject('name', 'WEBSITE_RUN_FROM_PACKAGE', 'value', '1'), createObject('name', 'AZURE_CLIENT_ID', 'value', reference(parameters('MSIid'), '2023-01-31').clientId), createObject('name', 'AgentApplication__StartTypingTimer', 'value', true()), createObject('name', 'AgentApplication__RemoveRecipientMention', 'value', false()), createObject('name', 'AgentApplication__NormalizeMentions', 'value', false()), createObject('name', 'AgentApplication__UserAuthorization__Handlers__SSO__Settings__AzureBotOAuthConnectionName', 'value', parameters('oauthConnectionName')), createObject('name', 'TokenValidation__Audiences__0', 'value', parameters('botId')), createObject('name', 'Connections__BotServiceConnection__Settings__AuthType', 'value', 'UserManagedIdentity'), createObject('name', 'Connections__BotServiceConnection__Settings__ClientId', 'value', parameters('botId')), createObject('name', 'Connections__BotServiceConnection__Settings__TenantId', 'value', parameters('botTenantId')), createObject('name', 'Connections__BotServiceConnection__Settings__Scopes__0', 'value', 'https://api.botframework.com/.default'), createObject('name', 'ConnectionsMap__ServiceUrl', 'value', '*'), createObject('name', 'ConnectionsMap__Connection', 'value', 'BotServiceConnection'), createObject('name', 'Logging__LogLevel__Default', 'value', 'Information'), createObject('name', 'Logging__LogLevel__Microsoft.AspNetCore', 'value', 'Warning'), createObject('name', 'Logging__LogLevel__Microsoft.Agents', 'value', 'Warning'), createObject('name', 'Logging__LogLevel__Microsoft.Hosting.Lifetime', 'value', 'Information')), if(and(parameters('enableAppInsights'), not(empty(parameters('appInsightsConnectionString')))), createArray(createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', parameters('appInsightsConnectionString')), createObject('name', 'ApplicationInsightsAgent_EXTENSION_VERSION', 'value', '~3'), createObject('name', 'XDT_MicrosoftApplicationInsights_Mode', 'value', 'recommended')), createArray()), if(not(empty(parameters('azureAIFoundryEndpoint'))), createArray(createObject('name', 'AIServices__AzureAIFoundryProjectEndpoint', 'value', parameters('azureAIFoundryEndpoint'))), createArray()), if(not(empty(parameters('azureAIAgentId'))), createArray(createObject('name', 'AIServices__AgentID', 'value', parameters('azureAIAgentId'))), createArray()), parameters('additionalAppSettings'))]",
                  "cors": {
                    "allowedOrigins": [
                      "https://portal.azure.com",
                      "https://ms.portal.azure.com"
                    ],
                    "supportCredentials": false
                  },
                  "metadata": [
                    {
                      "name": "CURRENT_STACK",
                      "value": "dotnet"
                    }
                  ]
                }
              },
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('MSIid'))]": {}
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('serverfarmsName'))]"
              ]
            }
          ],
          "outputs": {
            "webAppName": {
              "type": "string",
              "value": "[parameters('webAppName')]"
            },
            "webAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
            },
            "webAppHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-12-01').defaultHostName]"
            },
            "webAppPrincipalId": {
              "type": "string",
              "value": "[reference(parameters('MSIid'), '2023-01-31').principalId]"
            },
            "appServicePlanId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('serverfarmsName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-app-insights')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-bot-identity')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-azure-bot",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourceBaseName": {
            "value": "[parameters('resourceBaseName')]"
          },
          "botDisplayName": {
            "value": "[parameters('botDisplayName')]"
          },
          "botServiceName": {
            "value": "[variables('botServiceName')]"
          },
          "botServiceSku": {
            "value": "[parameters('botServiceSku')]"
          },
          "identityResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-bot-identity'), '2025-04-01').outputs.identityId.value]"
          },
          "identityClientId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-bot-identity'), '2025-04-01').outputs.identityClientId.value]"
          },
          "identityTenantId": {
            "value": "[parameters('tenantId')]"
          },
          "botAppDomain": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-service'), '2025-04-01').outputs.webAppHostName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "3591575307148508001"
            }
          },
          "parameters": {
            "resourceBaseName": {
              "type": "string",
              "minLength": 4,
              "maxLength": 20,
              "metadata": {
                "description": "Used to generate names for all resources in this file"
              }
            },
            "botDisplayName": {
              "type": "string",
              "maxLength": 42
            },
            "botServiceName": {
              "type": "string",
              "defaultValue": "[parameters('resourceBaseName')]"
            },
            "botServiceSku": {
              "type": "string",
              "defaultValue": "F0"
            },
            "identityResourceId": {
              "type": "string"
            },
            "identityClientId": {
              "type": "string"
            },
            "identityTenantId": {
              "type": "string"
            },
            "botAppDomain": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.BotService/botServices",
              "apiVersion": "2021-03-01",
              "name": "[parameters('botServiceName')]",
              "kind": "azurebot",
              "location": "global",
              "properties": {
                "displayName": "[parameters('botDisplayName')]",
                "endpoint": "[format('https://{0}/api/messages', parameters('botAppDomain'))]",
                "msaAppId": "[parameters('identityClientId')]",
                "msaAppMSIResourceId": "[parameters('identityResourceId')]",
                "msaAppTenantId": "[parameters('identityTenantId')]",
                "msaAppType": "UserAssignedMSI"
              },
              "sku": {
                "name": "[parameters('botServiceSku')]"
              }
            },
            {
              "type": "Microsoft.BotService/botServices/channels",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}/{1}', parameters('botServiceName'), 'MsTeamsChannel')]",
              "location": "global",
              "properties": {
                "channelName": "MsTeamsChannel"
              },
              "dependsOn": [
                "[resourceId('Microsoft.BotService/botServices', parameters('botServiceName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-app-service')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-bot-identity')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-app-registration",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aadAppName": {
            "value": "[variables('aadAppName')]"
          },
          "botId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-bot-identity'), '2025-04-01').outputs.identityClientId.value]"
          },
          "tenantId": {
            "value": "[parameters('tenantId')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "11985169748261135726"
            }
          },
          "parameters": {
            "aadAppName": {
              "type": "string",
              "metadata": {
                "description": "Application name for the Entra ID app registration"
              }
            },
            "botId": {
              "type": "string",
              "metadata": {
                "description": "BotID this should match the Microsoft App ID in the Azure Bot Service Configuration"
              }
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "Tenant ID where the application will be registered"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for resources"
              }
            }
          },
          "imports": {
            "microsoftGraphV1": {
              "provider": "MicrosoftGraph",
              "version": "1.0.0"
            }
          },
          "resources": {
            "aadApplication": {
              "import": "microsoftGraphV1",
              "type": "Microsoft.Graph/applications@v1.0",
              "properties": {
                "displayName": "[parameters('aadAppName')]",
                "uniqueName": "[parameters('aadAppName')]",
                "signInAudience": "AzureADMyOrg",
                "identifierUris": [
                  "[format('api://botid-{0}', parameters('botId'))]"
                ],
                "web": {
                  "redirectUris": [
                    "https://token.botframework.com/.auth/web/redirect"
                  ],
                  "implicitGrantSettings": {
                    "enableIdTokenIssuance": false,
                    "enableAccessTokenIssuance": false
                  }
                },
                "api": {
                  "requestedAccessTokenVersion": 2,
                  "oauth2PermissionScopes": [
                    {
                      "id": "[guid(resourceGroup().id, parameters('aadAppName'), 'access_as_user')]",
                      "adminConsentDescription": "Default scope for Agent SSO access",
                      "adminConsentDisplayName": "Agent SSO",
                      "userConsentDescription": "Default scope for Agent SSO access",
                      "userConsentDisplayName": "Agent SSO",
                      "value": "access_as_user",
                      "type": "User",
                      "isEnabled": true
                    }
                  ],
                  "preAuthorizedApplications": [
                    {
                      "appId": "1fec8e78-bce4-4aaf-ab1b-5451cc387264",
                      "delegatedPermissionIds": [
                        "[guid(resourceGroup().id, parameters('aadAppName'), 'access_as_user')]"
                      ]
                    },
                    {
                      "appId": "5e3ce6c0-2b1f-4285-8d4b-75ee78787346",
                      "delegatedPermissionIds": [
                        "[guid(resourceGroup().id, parameters('aadAppName'), 'access_as_user')]"
                      ]
                    },
                    {
                      "appId": "4765445b-32c6-49b0-83e6-1d93765276ca",
                      "delegatedPermissionIds": [
                        "[guid(resourceGroup().id, parameters('aadAppName'), 'access_as_user')]"
                      ]
                    },
                    {
                      "appId": "0ec893e0-5785-4de6-99da-4ed124e5296c",
                      "delegatedPermissionIds": [
                        "[guid(resourceGroup().id, parameters('aadAppName'), 'access_as_user')]"
                      ]
                    },
                    {
                      "appId": "d3590ed6-52b3-4102-aeff-aad2292ab01c",
                      "delegatedPermissionIds": [
                        "[guid(resourceGroup().id, parameters('aadAppName'), 'access_as_user')]"
                      ]
                    },
                    {
                      "appId": "bc59ab01-8403-45c6-8796-ac3ef710b3e3",
                      "delegatedPermissionIds": [
                        "[guid(resourceGroup().id, parameters('aadAppName'), 'access_as_user')]"
                      ]
                    },
                    {
                      "appId": "27922004-5251-4030-b22d-91ecd9a37ea4",
                      "delegatedPermissionIds": [
                        "[guid(resourceGroup().id, parameters('aadAppName'), 'access_as_user')]"
                      ]
                    }
                  ]
                },
                "requiredResourceAccess": [
                  {
                    "resourceAppId": "00000003-0000-0000-c000-000000000000",
                    "resourceAccess": [
                      {
                        "id": "37f7f235-527c-4136-accd-4a02d197296e",
                        "type": "Scope"
                      },
                      {
                        "id": "14dad69e-099b-42c9-810b-d002981feec1",
                        "type": "Scope"
                      },
                      {
                        "id": "64a6cdd6-aab1-4aaf-94b8-3cc8405e90d0",
                        "type": "Scope"
                      },
                      {
                        "id": "7427e0e9-2fba-42fe-b0c0-848c9e6a8182",
                        "type": "Scope"
                      }
                    ]
                  },
                  {
                    "resourceAppId": "18a66f5f-dbdf-4c17-9dd7-1634712a9cbe",
                    "resourceAccess": [
                      {
                        "id": "1a7925b5-f871-417a-9b8b-303f9f29fa10",
                        "type": "Scope"
                      }
                    ]
                  }
                ]
              }
            },
            "federatedCredential": {
              "import": "microsoftGraphV1",
              "type": "Microsoft.Graph/applications/federatedIdentityCredentials@v1.0",
              "properties": {
                "name": "[format('{0}/{1}', reference('aadApplication').uniqueName, guid(resourceGroup().id, parameters('aadAppName'), 'BotServiceOauthConnection'))]",
                "audiences": [
                  "api://AzureADTokenExchange"
                ],
                "issuer": "[format('{0}{1}/v2.0', environment().authentication.loginEndpoint, parameters('tenantId'))]",
                "subject": "[format('/eid1/c/pub/t/{0}/a/9ExAW52n_ky4ZiS_jhpJIQ/{1}', reference('tenantIdEncoder').outputs.encodedGuid.value, guid(resourceGroup().id, parameters('aadAppName'), 'BotServiceOauthConnection'))]",
                "description": "Federated credential for Bot Framework token exchange"
              },
              "dependsOn": [
                "aadApplication",
                "tenantIdEncoder"
              ]
            },
            "aadServicePrincipal": {
              "import": "microsoftGraphV1",
              "type": "Microsoft.Graph/servicePrincipals@v1.0",
              "properties": {
                "appId": "[reference('aadApplication').appId]",
                "accountEnabled": true,
                "displayName": "[parameters('aadAppName')]",
                "servicePrincipalType": "Application",
                "tags": [
                  "WindowsAzureActiveDirectoryIntegratedApp"
                ]
              },
              "dependsOn": [
                "aadApplication"
              ]
            },
            "tenantIdEncoder": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('encode-tenant-{0}', uniqueString(parameters('tenantId')))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "guidToEncode": {
                    "value": "[parameters('tenantId')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "12339729127578324664"
                    }
                  },
                  "parameters": {
                    "guidToEncode": {
                      "type": "string",
                      "metadata": {
                        "description": "The GUID to encode"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Location for the deployment script"
                      }
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]",
                      "metadata": {
                        "description": "Timestamp to force script re-execution"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "[format('guid-encoder-{0}', uniqueString(parameters('guidToEncode'), parameters('utcValue')))]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "properties": {
                        "azCliVersion": "2.52.0",
                        "retentionInterval": "PT1H",
                        "timeout": "PT5M",
                        "cleanupPreference": "OnSuccess",
                        "forceUpdateTag": "[parameters('utcValue')]",
                        "scriptContent": "      #!/bin/bash\r\n      set -e\r\n      \r\n      GUID_VALUE=\"$1\"\r\n      \r\n      echo \"Converting GUID: $GUID_VALUE\"\r\n      \r\n      # Remove hyphens from GUID\r\n      GUID_NO_HYPHENS=$(echo \"$GUID_VALUE\" | tr -d '-')\r\n      \r\n      # Extract parts of the GUID\r\n      # GUID format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\r\n      # Byte order needs to be adjusted for little-endian encoding\r\n      PART1=\"${GUID_NO_HYPHENS:0:8}\"   # First 8 chars (4 bytes)\r\n      PART2=\"${GUID_NO_HYPHENS:8:4}\"   # Next 4 chars (2 bytes)\r\n      PART3=\"${GUID_NO_HYPHENS:12:4}\"  # Next 4 chars (2 bytes)\r\n      PART4=\"${GUID_NO_HYPHENS:16:16}\" # Last 16 chars (8 bytes)\r\n      \r\n      # Reverse byte order for first three parts (little-endian)\r\n      BYTES=\"\"\r\n      BYTES+=\"${PART1:6:2}${PART1:4:2}${PART1:2:2}${PART1:0:2}\"\r\n      BYTES+=\"${PART2:2:2}${PART2:0:2}\"\r\n      BYTES+=\"${PART3:2:2}${PART3:0:2}\"\r\n      BYTES+=\"$PART4\"\r\n      \r\n      echo \"Hex bytes: $BYTES\"\r\n      \r\n      # Convert hex to binary and then to base64\r\n      BASE64=$(echo \"$BYTES\" | xxd -r -p | base64)\r\n      \r\n      # Convert to Base64URL (remove padding, replace + with -, / with _)\r\n      BASE64URL=$(echo \"$BASE64\" | tr '+' '-' | tr '/' '_' | tr -d '=\\n')\r\n      \r\n      echo \"Base64URL encoded: $BASE64URL\"\r\n      \r\n      # Output result as JSON\r\n      echo \"{\\\"encodedGuid\\\":\\\"$BASE64URL\\\"}\" > $AZ_SCRIPTS_OUTPUT_PATH\r\n    ",
                        "arguments": "[parameters('guidToEncode')]"
                      }
                    }
                  ],
                  "outputs": {
                    "encodedGuid": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('guid-encoder-{0}', uniqueString(parameters('guidToEncode'), parameters('utcValue')))), '2023-08-01').outputs.encodedGuid]"
                    }
                  }
                }
              }
            }
          },
          "outputs": {
            "aadAppId": {
              "type": "string",
              "value": "[reference('aadApplication').appId]"
            },
            "aadAppObjectId": {
              "type": "string",
              "value": "[reference('aadApplication').id]"
            },
            "aadAppIdUri": {
              "type": "string",
              "value": "[format('api://botid-{0}', parameters('botId'))]"
            },
            "servicePrincipalId": {
              "type": "string",
              "value": "[reference('aadServicePrincipal').id]"
            },
            "servicePrincipalObjectId": {
              "type": "string",
              "value": "[reference('aadServicePrincipal').id]"
            },
            "fciName": {
              "type": "string",
              "value": "[reference('federatedCredential').name]"
            },
            "fciSubject": {
              "type": "string",
              "value": "[format('/eid1/c/pub/t/{0}/a/9ExAW52n_ky4ZiS_jhpJIQ/{1}', reference('tenantIdEncoder').outputs.encodedGuid.value, guid(resourceGroup().id, parameters('aadAppName'), 'BotServiceOauthConnection'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-azure-bot')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-bot-identity')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-bot-oauth-connection",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "botServiceName": {
            "value": "[variables('botServiceName')]"
          },
          "connectionName": {
            "value": "SsoConnection"
          },
          "aadAppId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-registration'), '2025-04-01').outputs.aadAppId.value]"
          },
          "aadAppIdUri": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-registration'), '2025-04-01').outputs.aadAppIdUri.value]"
          },
          "federatedCredentialSubject": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-registration'), '2025-04-01').outputs.fciName.value]"
          },
          "scopes": {
            "value": "[format('{0}/access_as_user', reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-registration'), '2025-04-01').outputs.aadAppIdUri.value)]"
          },
          "tenantId": {
            "value": "[parameters('tenantId')]"
          },
          "location": {
            "value": "global"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "9760687786267362268"
            }
          },
          "parameters": {
            "botServiceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Bot Service to configure"
              }
            },
            "connectionName": {
              "type": "string",
              "defaultValue": "SsoConnection",
              "metadata": {
                "description": "The name for the OAuth connection setting"
              }
            },
            "aadAppId": {
              "type": "string",
              "metadata": {
                "description": "The Azure AD Application (client) ID from the app registration"
              }
            },
            "aadAppIdUri": {
              "type": "string",
              "metadata": {
                "description": "The Azure AD Application ID URI (e.g., api://botid-{guid})"
              }
            },
            "federatedCredentialSubject": {
              "type": "string",
              "metadata": {
                "description": "The federated credential subject (unique identifier from the federated credential)"
              }
            },
            "scopes": {
              "type": "string",
              "metadata": {
                "description": "OAuth scopes to request - should be the app ID URI with access_as_user scope"
              }
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "The tenant ID for the Azure AD application"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "global",
              "metadata": {
                "description": "Location for the connection resource"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.BotService/botServices/connections",
              "apiVersion": "2022-09-15",
              "name": "[format('{0}/{1}', parameters('botServiceName'), parameters('connectionName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "serviceProviderId": "c00b44ab-5e16-c44c-af26-2fd5bc55eb18",
                "serviceProviderDisplayName": "AAD v2 with Federated Credentials",
                "clientId": "[parameters('aadAppId')]",
                "scopes": "[parameters('scopes')]",
                "parameters": [
                  {
                    "key": "ClientId",
                    "value": "[parameters('aadAppId')]"
                  },
                  {
                    "key": "UniqueIdentifier",
                    "value": "[parameters('federatedCredentialSubject')]"
                  },
                  {
                    "key": "TokenExchangeUrl",
                    "value": "[parameters('aadAppIdUri')]"
                  },
                  {
                    "key": "TenantId",
                    "value": "[parameters('tenantId')]"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "connectionName": {
              "type": "string",
              "value": "[parameters('connectionName')]"
            },
            "connectionId": {
              "type": "string",
              "value": "[resourceId('Microsoft.BotService/botServices/connections', split(format('{0}/{1}', parameters('botServiceName'), parameters('connectionName')), '/')[0], split(format('{0}/{1}', parameters('botServiceName'), parameters('connectionName')), '/')[1])]"
            },
            "settingId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.BotService/botServices/connections', split(format('{0}/{1}', parameters('botServiceName'), parameters('connectionName')), '/')[0], split(format('{0}/{1}', parameters('botServiceName'), parameters('connectionName')), '/')[1]), '2022-09-15').settingId]"
            },
            "provisioningState": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.BotService/botServices/connections', split(format('{0}/{1}', parameters('botServiceName'), parameters('connectionName')), '/')[0], split(format('{0}/{1}', parameters('botServiceName'), parameters('connectionName')), '/')[1]), '2022-09-15').provisioningState]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-app-registration')]"
      ]
    }
  ],
  "outputs": {
    "resourceBaseName": {
      "type": "string",
      "value": "[parameters('resourceBaseName')]"
    },
    "location": {
      "type": "string",
      "value": "[parameters('location')]"
    },
    "identityName": {
      "type": "string",
      "value": "[variables('identityName')]"
    },
    "identityId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-bot-identity'), '2025-04-01').outputs.identityClientId.value]"
    },
    "identityPrincipalId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-bot-identity'), '2025-04-01').outputs.identityPrincipalId.value]"
    },
    "webAppName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-service'), '2025-04-01').outputs.webAppName.value]"
    },
    "webAppId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-service'), '2025-04-01').outputs.webAppId.value]"
    },
    "webAppHostName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-service'), '2025-04-01').outputs.webAppHostName.value]"
    },
    "webAppUrl": {
      "type": "string",
      "value": "[format('https://{0}', reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-service'), '2025-04-01').outputs.webAppHostName.value)]"
    },
    "appServicePlanId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-service'), '2025-04-01').outputs.appServicePlanId.value]"
    },
    "BOT_ID": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-bot-identity'), '2025-04-01').outputs.identityClientId.value]"
    },
    "botServiceName": {
      "type": "string",
      "value": "[variables('botServiceName')]"
    },
    "botEndpoint": {
      "type": "string",
      "value": "[format('https://{0}/api/messages', reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-service'), '2025-04-01').outputs.webAppHostName.value)]"
    },
    "AAD_APP_CLIENT_ID": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-registration'), '2025-04-01').outputs.aadAppId.value]"
    },
    "AAD_APP_ID_URI": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-registration'), '2025-04-01').outputs.aadAppIdUri.value]"
    },
    "federatedCredentialName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-registration'), '2025-04-01').outputs.fciName.value]"
    },
    "appInsightsName": {
      "type": "string",
      "value": "[coalesce(tryGet(tryGet(tryGet(if(parameters('enableAppInsights'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-insights'), '2025-04-01'), null()), 'outputs'), 'appInsightsName'), 'value'), '')]"
    },
    "appInsightsConnectionString": {
      "type": "string",
      "value": "[coalesce(tryGet(tryGet(tryGet(if(parameters('enableAppInsights'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-insights'), '2025-04-01'), null()), 'outputs'), 'appInsightsConnectionString'), 'value'), '')]"
    },
    "appInsightsInstrumentationKey": {
      "type": "string",
      "value": "[coalesce(tryGet(tryGet(tryGet(if(parameters('enableAppInsights'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-insights'), '2025-04-01'), null()), 'outputs'), 'appInsightsInstrumentationKey'), 'value'), '')]"
    },
    "logAnalyticsWorkspaceName": {
      "type": "string",
      "value": "[coalesce(tryGet(tryGet(tryGet(if(parameters('enableAppInsights'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-insights'), '2025-04-01'), null()), 'outputs'), 'logAnalyticsWorkspaceName'), 'value'), '')]"
    }
  }
}