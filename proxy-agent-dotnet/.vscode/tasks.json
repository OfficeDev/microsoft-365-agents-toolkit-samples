{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "Start Teams App Locally",
      "dependsOn": [
        "Ensure env files",
        "Ensure DevTunnel",
        "Validate prerequisites",
        "Provision",
        "Start application"
      ],
      "dependsOrder": "sequence"
    },
    {
      "label": "Ensure env files",
      "type": "shell",
      "command": "node ./scripts/env.js",
      "isBackground": true,
      "problemMatcher": {
        "pattern": [
          {
            "regexp": "^.*$",
            "file": 0,
            "location": 1,
            "message": 2
          }
        ],
        "background": {
          "activeOnStart": true,
          "beginsPattern": "Ensuring env files exist...",
          "endsPattern": "Done!"
        }
      },
      "options": {
        "cwd": "${workspaceFolder}/M365Agent"
      },
      "presentation": {
        "reveal": "silent",
        "panel": "shared"
      }
    },
    {
      "label": "Ensure DevTunnel",
      "type": "shell",
      "isBackground": true,
      "windows": {
        "command": ".\\scripts\\devtunnel.ps1"
      },
      "osx": {
        "command": "./scripts/devtunnel.sh"
      },
      "linux": {
        "command": "./scripts/devtunnel.sh"
      },
      "problemMatcher": {
        "pattern": [
          {
            "regexp": "^.*$",
            "file": 0,
            "location": 1,
            "message": 2
          }
        ],
        "background": {
          "activeOnStart": true,
          "beginsPattern": "No TUNNEL_ID found. Creating tunnel...|Connecting to host tunnel relay",
          "endsPattern": "Ready to accept connections for tunnel"
        }
      },
      "options": {
        "cwd": "${workspaceFolder}/M365Agent"
      },
      "presentation": {
        "reveal": "silent",
        "panel": "dedicated"
      },
      "dependsOn": [
        "Ensure env files"
      ]
    },
    {
      "label": "Validate prerequisites",
      "type": "teamsfx",
      "command": "debug-check-prerequisites",
      "args": {
        "prerequisites": [
          "nodejs",
          "m365Account",
          "portOccupancy"
        ],
        "portOccupancy": [
          5130
        ]
      },
      "options": {
        "cwd": "${workspaceFolder}/M365Agent"
      }
    },
    {
      "label": "Provision",
      "type": "teamsfx",
      "command": "provision",
      "args": {
        "env": "local"
      }
    },
    {
      "label": "Start application",
      "type": "shell",
      "command": "dotnet",
      "args": [
        "run",
        "--project",
        "${workspaceFolder}/AzureAgentToM365ATK/AzureAgentToM365ATK.csproj",
        "--configuration",
        "Debug",
        "--launch-profile",
        "Start Project"
      ],
      "isBackground": true,
      "problemMatcher": {
        "pattern": [
          {
            "regexp": "^.*$",
            "file": 0,
            "location": 1,
            "message": 2
          }
        ],
        "background": {
          "activeOnStart": true,
          "beginsPattern": "^.*Building.*$",
          "endsPattern": "^.*Application started.*|.*Now listening on.*$"
        }
      },
      "presentation": {
        "reveal": "always",
        "panel": "dedicated"
      },
      "options": {
        "cwd": "${workspaceFolder}/AzureAgentToM365ATK",
        "env": {
          "ASPNETCORE_ENVIRONMENT": "Development"
        }
      }
    },
    {
      "label": "Stop All Services",
      "type": "shell",
      "command": "echo 'Stopping services...' && taskkill /F /IM dotnet.exe /T 2>$null; taskkill /F /IM devtunnel.exe /T 2>$null; taskkill /F /IM node.exe /T 2>$null; echo 'Services stopped'",
      "presentation": {
        "reveal": "always",
        "panel": "shared"
      }
    }
  ]
}